<!doctype html>
<html>

<head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="/css/bootstrap.css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="/css/style.css" media="screen" title="no title" charset="utf-8">
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="col-md-6 col-md-offset-3">
                <h1 class="navbar-brand">clash drawer</h1>
            </div>
        </div>
    </nav>

    <div class="container-fluid padding-0">
        <div class="col-xs-3 column-1">
            <div class="column-header">
                <h3>Clan</h3>
            </div>
            <div class="clan-info">
                <img src="/images/logo.png" class="clan-logo" alt="">
                <h2 class="clan-name">Legacy-Clan</h2>
                <dl>
                    <dt>Tag:</dt>
                    <dd id="clan-tag"></dd>
                    <dt>Members:</dt>
                    <dd id="clan-members-count"></dd>
                    <dt>Required Trophies:</dt>
                    <dd id="clan-required-trophies"></dd>
                    <dt>War Wins:</dt>
                    <dd id="clan-war-wins"></dd>
                    <dt>War Win Streak:</dt>
                    <dd id="clan-war-win-streak"></dd>
                </dl>

                <div id="clan-members-list"></div>



            </div>

        </div>
        <div class="col-xs-6 column-2 main-chat">
            <div class="column-header">
                <h3>Chat</h3>
            </div>
            <ul id="messages"></ul>

            <div class="container text-bar">
                <div class="col-md-12">
                    <form action="">
                        <input id="m" autocomplete="off" placeholder="Your message" />
                    </form>
                </div>
            </div>
        </div>
        <div class="col-xs-3 column-3">
            <div class="column-header">
                <h3>Attack Plan</h3>
            </div>
        </div>
    </div>


    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.js"></script>

    <script>
        var socket = io();
        var clanInfo = '';

        $(function() {
            // Fill
            updateMessageContainerHeight();

            $(window).resize(function() {
                updateMessageContainerHeight();
            });

            $.getJSON("/msg/all", function(msgs) {
                $.each(msgs, function(i, msg) {
                    $('#messages').append($('<li>').text(msg.username + ": " + msg.content));
                });
                updateMessageContainerHeight();
            });

            $.getJSON("/members.json", function(clan) {
                $('#clan-tag').html(clan.tag);
                $('#clan-members-count').html(clan.members + "/50");
                $('#clan-required-trophies').html(clan.requiredTrophies);
                $('#clan-war-wins').html(clan.warWins);
                $('#clan-war-win-streak').html(clan.warWinStreak);

                $.each(clan.memberList, function(i, member) {
                    $('#clan-members-list').append('<span class="label id' + member.league.id + '"><img src="' + member.league.iconUrls.tiny + '">' + member.name);
                });
            });
        });

        function updateMessageContainerHeight() {
            $('#messages').height(($(window).height() - $('nav').height() - $('.text-bar').height() - $('.column-header').height() ));
            $('.clan-info').height(($(window).height() - $('nav').height()  - $('.column-header').height() - 1));
            $('.column-1, .column-3').height(($(window).height() - $('nav').height()  - $('.column-header').height() + $('.text-bar').height() - 13));

            $('#messages').scrollTop($('#messages').prop("scrollHeight"));        }

        $('form').submit(function() {
            socket.emit('chat message', $('#m').val());
            $('#m').val('');
            return false;
        });

        socket.on('chat message', function(msg) {
            console.log(msg);
            $('#messages').append($('<li>').text(msg.username + ": " + msg.content));
            updateMessageContainerHeight();
        });
    </script>
</body>

</html>
